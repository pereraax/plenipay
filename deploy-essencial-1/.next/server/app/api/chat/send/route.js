"use strict";(()=>{var e={};e.id=7333,e.ids=[7333],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},1145:(e,s,r)=>{r.r(s),r.d(s,{headerHooks:()=>g,originalPathname:()=>v,patchFetch:()=>I,requestAsyncStorage:()=>d,routeModule:()=>l,serverHooks:()=>p,staticGenerationAsyncStorage:()=>m,staticGenerationBailout:()=>h});var a={};r.r(a),r.d(a,{POST:()=>u});var o=r(95419),t=r(69108),n=r(99678),i=r(81664),c=r(78070);async function u(e){try{console.log("\uD83D\uDCE5 Recebendo requisi\xe7\xe3o de envio de mensagem...");let s=await (0,i.eI)(),{data:{user:r}}=await s.auth.getUser();if(!r)return console.error("âŒ Usu\xe1rio n\xe3o autenticado"),c.Z.json({error:"N\xe3o autenticado"},{status:401});console.log("âœ… Usu\xe1rio autenticado:",r.id);let{message:a}=await e.json();if(console.log("\uD83D\uDCDD Mensagem recebida:",a?.substring(0,100)+"..."),!a||!a.trim())return console.error("âŒ Mensagem vazia"),c.Z.json({error:"Mensagem n\xe3o pode estar vazia"},{status:400});let{data:o,error:t}=await s.from("chat_messages").select("id, sender_type, message").eq("user_id",r.id).order("created_at",{ascending:!0});t&&console.error("Erro ao verificar mensagens existentes:",t);let n=!o||0===o.length;o?.some(e=>"support"===e.sender_type&&(e.message.includes("Ol\xe1!")||e.message.includes("Bem-vindo")||e.message.includes("nome")||e.message.includes("email"))),o?.some(e=>"support"===e.sender_type&&(e.message.includes("ajudar")||e.message.includes("d\xfavida")||e.message.includes("problema")));let{data:u,error:l}=await s.from("chat_conversations").select("is_closed").eq("user_id",r.id).single(),d=u?.is_closed||!1;if(d){console.log("\uD83D\uDD04 Reabrindo conversa finalizada...");let{error:e}=await s.from("chat_conversations").upsert({user_id:r.id,is_closed:!1,closed_at:null,closed_by:null,assigned_agent_name:null,updated_at:new Date().toISOString()},{onConflict:"user_id"});e?console.error("âŒ Erro ao reabrir conversa:",e):console.log("âœ… Conversa reaberta com sucesso")}console.log("\uD83D\uDCBE Salvando mensagem no banco...");let{data:m,error:p}=await s.from("chat_messages").insert([{user_id:r.id,message:a.trim(),sender_type:"user",is_read:!1}]).select().single();if(p)return console.error("âŒ Erro ao salvar mensagem:",p),c.Z.json({error:"Erro ao enviar mensagem: "+p.message},{status:500});console.log("âœ… Mensagem salva com sucesso:",m?.id);let g=a.trim(),h=g.includes("Nome:")&&g.includes("Email:")&&g.includes("Motivo:");if(d&&!n&&!h){let e=`Ol\xe1! Vejo que voc\xea enviou uma nova mensagem. Reabri esta conversa para voc\xea! ðŸ˜Š

Como posso ajud\xe1-lo hoje?`,{error:a}=await s.from("chat_messages").insert([{user_id:r.id,message:e,sender_type:"support",is_read:!1}]);a&&console.error("Erro ao enviar mensagem de reabertura:",a)}return c.Z.json({success:!0,data:m})}catch(e){return console.error("Erro inesperado:",e),c.Z.json({error:"Erro inesperado ao enviar mensagem"},{status:500})}}let l=new o.AppRouteRouteModule({definition:{kind:t.x.APP_ROUTE,page:"/api/chat/send/route",pathname:"/api/chat/send",filename:"route",bundlePath:"app/api/chat/send/route"},resolvedPagePath:"/Users/charllestabordas/Documents/SISTEMA DE CONTAS/app/api/chat/send/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:d,staticGenerationAsyncStorage:m,serverHooks:p,headerHooks:g,staticGenerationBailout:h}=l,v="/api/chat/send/route";function I(){return(0,n.patchFetch)({serverHooks:p,staticGenerationAsyncStorage:m})}},81664:(e,s,r)=>{r.d(s,{eI:()=>n,i3:()=>i,vv:()=>c});var a=r(77497),o=r(94128),t=r(32455);let n=(0,r(40002).cache)(async()=>{let e=await (0,t.cookies)();return(0,a.createServerClient)("https://frhxqgcqmxpjpnghsvoe.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZyaHhxZ2NxbXhwanBuZ2hzdm9lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2NTM3NTYsImV4cCI6MjA3OTIyOTc1Nn0.p1OxLRA5DKgvetuy-IbCfYClNSjrvK6fm43aZNX3T7I",{cookies:{getAll:()=>e.getAll(),setAll(s){try{s.forEach(({name:s,value:r,options:a})=>e.set(s,r,a))}catch{}}}})});function i(){let e=process.env.SUPABASE_SERVICE_ROLE_KEY;return e?(0,o.eI)("https://frhxqgcqmxpjpnghsvoe.supabase.co",e,{auth:{autoRefreshToken:!1,persistSession:!1}}):null}function c(){return(0,o.eI)("https://frhxqgcqmxpjpnghsvoe.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZyaHhxZ2NxbXhwanBuZ2hzdm9lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2NTM3NTYsImV4cCI6MjA3OTIyOTc1Nn0.p1OxLRA5DKgvetuy-IbCfYClNSjrvK6fm43aZNX3T7I",{auth:{autoRefreshToken:!1,persistSession:!1}})}},50482:(e,s,r)=>{e.exports=r(20399)},40002:(e,s,r)=>{e.exports=r(50482).vendored["react-rsc"].React},95419:(e,s,r)=>{e.exports=r(30517)}};var s=require("../../../../webpack-runtime.js");s.C(e);var r=e=>s(s.s=e),a=s.X(0,[1638,2455,4128,7497,8070],()=>r(1145));module.exports=a})();