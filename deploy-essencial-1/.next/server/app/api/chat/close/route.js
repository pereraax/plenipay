"use strict";(()=>{var e={};e.id=8410,e.ids=[8410],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},31579:(e,r,t)=>{t.r(r),t.d(r,{headerHooks:()=>h,originalPathname:()=>g,patchFetch:()=>f,requestAsyncStorage:()=>d,routeModule:()=>l,serverHooks:()=>m,staticGenerationAsyncStorage:()=>p,staticGenerationBailout:()=>I});var s={};t.r(s),t.d(s,{POST:()=>u});var a=t(95419),o=t(69108),n=t(99678),i=t(81664),c=t(78070);async function u(e){try{let r=await (0,i.eI)(),{data:{user:t}}=await r.auth.getUser();if(!t)return c.Z.json({error:"N\xe3o autenticado"},{status:401});let{user_id:s}=await e.json();if(!s)return c.Z.json({error:"user_id \xe9 obrigat\xf3rio"},{status:400});let{data:a,error:o}=await r.from("chat_conversations").select("*").eq("user_id",s).maybeSingle();if(o&&"PGRST116"!==o.code)return console.error("Erro ao buscar conversa:",o),c.Z.json({error:"Erro ao buscar conversa: "+o.message},{status:500});if(a){let e={is_closed:!0,closed_at:new Date().toISOString(),closed_by:t.id,updated_at:new Date().toISOString(),assigned_agent_name:null},{data:o,error:n}=await r.from("chat_conversations").update(e).eq("user_id",s).select().maybeSingle();if(n){if(console.error("Erro ao finalizar conversa:",n),n.message?.includes("assigned_agent_name")||"42703"===n.code){console.log("Campo assigned_agent_name n\xe3o existe, tentando sem ele...");let e={is_closed:!0,closed_at:new Date().toISOString(),closed_by:t.id,updated_at:new Date().toISOString()},{data:o,error:n}=await r.from("chat_conversations").update(e).eq("user_id",s).select().maybeSingle();if(n)return c.Z.json({error:"Erro ao finalizar conversa: "+n.message},{status:500});return c.Z.json({success:!0,data:o||a})}return c.Z.json({error:"Erro ao finalizar conversa: "+n.message},{status:500})}return c.Z.json({success:!0,data:o||a})}{let e={user_id:s,is_closed:!0,closed_at:new Date().toISOString(),closed_by:t.id},{data:a,error:o}=await r.from("chat_conversations").insert([e]).select().maybeSingle();if(o)return console.error("Erro ao criar conversa finalizada:",o),c.Z.json({error:"Erro ao finalizar conversa: "+o.message},{status:500});return c.Z.json({success:!0,data:a||{user_id:s,is_closed:!0}})}}catch(e){return console.error("Erro inesperado:",e),c.Z.json({error:"Erro inesperado ao finalizar conversa"},{status:500})}}let l=new a.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/chat/close/route",pathname:"/api/chat/close",filename:"route",bundlePath:"app/api/chat/close/route"},resolvedPagePath:"/Users/charllestabordas/Documents/SISTEMA DE CONTAS/app/api/chat/close/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:d,staticGenerationAsyncStorage:p,serverHooks:m,headerHooks:h,staticGenerationBailout:I}=l,g="/api/chat/close/route";function f(){return(0,n.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:p})}},81664:(e,r,t)=>{t.d(r,{eI:()=>n,i3:()=>i,vv:()=>c});var s=t(77497),a=t(94128),o=t(32455);let n=(0,t(40002).cache)(async()=>{let e=await (0,o.cookies)();return(0,s.createServerClient)("https://frhxqgcqmxpjpnghsvoe.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZyaHhxZ2NxbXhwanBuZ2hzdm9lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2NTM3NTYsImV4cCI6MjA3OTIyOTc1Nn0.p1OxLRA5DKgvetuy-IbCfYClNSjrvK6fm43aZNX3T7I",{cookies:{getAll:()=>e.getAll(),setAll(r){try{r.forEach(({name:r,value:t,options:s})=>e.set(r,t,s))}catch{}}}})});function i(){let e=process.env.SUPABASE_SERVICE_ROLE_KEY;return e?(0,a.eI)("https://frhxqgcqmxpjpnghsvoe.supabase.co",e,{auth:{autoRefreshToken:!1,persistSession:!1}}):null}function c(){return(0,a.eI)("https://frhxqgcqmxpjpnghsvoe.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZyaHhxZ2NxbXhwanBuZ2hzdm9lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2NTM3NTYsImV4cCI6MjA3OTIyOTc1Nn0.p1OxLRA5DKgvetuy-IbCfYClNSjrvK6fm43aZNX3T7I",{auth:{autoRefreshToken:!1,persistSession:!1}})}},50482:(e,r,t)=>{e.exports=t(20399)},40002:(e,r,t)=>{e.exports=t(50482).vendored["react-rsc"].React},95419:(e,r,t)=>{e.exports=t(30517)}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[1638,2455,4128,7497,8070],()=>t(31579));module.exports=s})();