"use strict";(()=>{var e={};e.id=3514,e.ids=[3514],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},36685:(e,a,t)=>{t.r(a),t.d(a,{headerHooks:()=>h,originalPathname:()=>g,patchFetch:()=>v,requestAsyncStorage:()=>d,routeModule:()=>u,serverHooks:()=>I,staticGenerationAsyncStorage:()=>m,staticGenerationBailout:()=>f});var o={};t.r(o),t.d(o,{POST:()=>l});var r=t(95419),s=t(69108),n=t(99678),i=t(81664),c=t(78070);let p=process.env.ASAAS_WEBHOOK_TOKEN;async function l(e){try{let a=await e.text(),t=e.headers.get("asaas-access-token")||"";if(!p||!t||t!==p)return console.error("Webhook signature inv\xe1lida"),c.Z.json({error:"Assinatura inv\xe1lida"},{status:401});let o=JSON.parse(a),r=await (0,i.eI)();if(console.log("\uD83D\uDCE5 Webhook recebido:",o.event,o.payment||o.subscription),"PAYMENT_CONFIRMED"===o.event||"PAYMENT_RECEIVED"===o.event){let e=o.payment;if(!e||!e.customer)return c.Z.json({error:"Dados de pagamento inv\xe1lidos"},{status:400});let{data:a,error:t}=await r.from("profiles").select("*").eq("asaas_customer_id",e.customer).single();if(t||!a)return console.error("Perfil n\xe3o encontrado para customer:",e.customer),c.Z.json({error:"Perfil n\xe3o encontrado"},{status:404});let s=new Date;s.setMonth(s.getMonth()+1);let{error:n}=await r.from("profiles").update({plano_status:"ativo",plano_data_fim:s.toISOString()}).eq("id",a.id);n?console.error("Erro ao atualizar plano:",n):console.log("✅ Plano ativado para usu\xe1rio:",a.id);let{error:i}=await r.from("pagamentos").insert({user_id:a.id,plano:a.plano,valor:e.value,status:"pago",asaas_payment_id:e.id,asaas_subscription_id:e.subscription,metodo_pagamento:e.billingType,data_pagamento:e.confirmedDate||e.dueDate||new Date().toISOString()});i&&console.error("Erro ao registrar pagamento:",i)}if("SUBSCRIPTION_DELETED"===o.event||"SUBSCRIPTION_CANCELLED"===o.event){let e=o.subscription;if(!e||!e.id)return c.Z.json({error:"Dados de assinatura inv\xe1lidos"},{status:400});let{data:a,error:t}=await r.from("profiles").select("*").eq("asaas_subscription_id",e.id).single();if(t||!a)return console.error("Perfil n\xe3o encontrado para subscription:",e.id),c.Z.json({error:"Perfil n\xe3o encontrado"},{status:404});let{error:s}=await r.from("profiles").update({plano_status:"cancelado",plano:"teste",plano_data_fim:new Date().toISOString()}).eq("id",a.id);s?console.error("Erro ao cancelar plano:",s):console.log("✅ Plano cancelado para usu\xe1rio:",a.id)}if("PAYMENT_CREATED"===o.event){let e=o.payment;if(e&&e.customer){let{data:a}=await r.from("profiles").select("*").eq("asaas_customer_id",e.customer).single();a&&await r.from("pagamentos").insert({user_id:a.id,plano:a.plano||"basico",valor:e.value,status:"pendente",asaas_payment_id:e.id,asaas_subscription_id:e.subscription,metodo_pagamento:e.billingType})}}return c.Z.json({success:!0})}catch(e){return console.error("❌ Erro no webhook:",e),c.Z.json({error:"Erro ao processar webhook"},{status:500})}}let u=new r.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/webhooks/asaas/route",pathname:"/api/webhooks/asaas",filename:"route",bundlePath:"app/api/webhooks/asaas/route"},resolvedPagePath:"/Users/charllestabordas/Documents/SISTEMA DE CONTAS/app/api/webhooks/asaas/route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:d,staticGenerationAsyncStorage:m,serverHooks:I,headerHooks:h,staticGenerationBailout:f}=u,g="/api/webhooks/asaas/route";function v(){return(0,n.patchFetch)({serverHooks:I,staticGenerationAsyncStorage:m})}},81664:(e,a,t)=>{t.d(a,{eI:()=>n,i3:()=>i,vv:()=>c});var o=t(77497),r=t(94128),s=t(32455);let n=(0,t(40002).cache)(async()=>{let e=await (0,s.cookies)();return(0,o.createServerClient)("https://frhxqgcqmxpjpnghsvoe.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZyaHhxZ2NxbXhwanBuZ2hzdm9lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2NTM3NTYsImV4cCI6MjA3OTIyOTc1Nn0.p1OxLRA5DKgvetuy-IbCfYClNSjrvK6fm43aZNX3T7I",{cookies:{getAll:()=>e.getAll(),setAll(a){try{a.forEach(({name:a,value:t,options:o})=>e.set(a,t,o))}catch{}}}})});function i(){let e=process.env.SUPABASE_SERVICE_ROLE_KEY;return e?(0,r.eI)("https://frhxqgcqmxpjpnghsvoe.supabase.co",e,{auth:{autoRefreshToken:!1,persistSession:!1}}):null}function c(){return(0,r.eI)("https://frhxqgcqmxpjpnghsvoe.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZyaHhxZ2NxbXhwanBuZ2hzdm9lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2NTM3NTYsImV4cCI6MjA3OTIyOTc1Nn0.p1OxLRA5DKgvetuy-IbCfYClNSjrvK6fm43aZNX3T7I",{auth:{autoRefreshToken:!1,persistSession:!1}})}},50482:(e,a,t)=>{e.exports=t(20399)},40002:(e,a,t)=>{e.exports=t(50482).vendored["react-rsc"].React},95419:(e,a,t)=>{e.exports=t(30517)}};var a=require("../../../../webpack-runtime.js");a.C(e);var t=e=>a(a.s=e),o=a.X(0,[1638,2455,4128,7497,8070],()=>t(36685));module.exports=o})();