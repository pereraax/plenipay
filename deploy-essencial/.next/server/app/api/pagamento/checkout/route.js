"use strict";(()=>{var e={};e.id=950,e.ids=[950],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},67799:(e,o,a)=>{a.r(o),a.d(o,{headerHooks:()=>f,originalPathname:()=>D,patchFetch:()=>I,requestAsyncStorage:()=>m,routeModule:()=>d,serverHooks:()=>h,staticGenerationAsyncStorage:()=>g,staticGenerationBailout:()=>C});var t={};a.r(t),a.d(t,{POST:()=>p});var r=a(95419),s=a(69108),n=a(99678),i=a(81664),c=a(84113),l=a(78070);let u={basico:29.9,premium:49.9};async function p(e){try{let o;let a=process.env.ASAAS_API_KEY;if(console.log("\uD83D\uDD11 Verificando API Key no servidor:",{exists:!!a,length:a?.length||0,prefix:a?a.substring(0,20)+"...":"N/A",startsWithDollar:a?.startsWith("$")||!1}),!a)return console.error("❌ ASAAS_API_KEY n\xe3o est\xe1 configurada"),l.Z.json({error:"Configura\xe7\xe3o do Asaas n\xe3o encontrada. Entre em contato com o suporte."},{status:500});let t=await (0,i.eI)(),{data:{user:r}}=await t.auth.getUser();if(!r)return l.Z.json({error:"N\xe3o autenticado"},{status:401});let{plano:s,metodoPagamento:n}=await e.json();if(!["basico","premium"].includes(s))return l.Z.json({error:"Plano inv\xe1lido"},{status:400});if(!["PIX","BOLETO","CREDIT_CARD"].includes(n))return l.Z.json({error:"M\xe9todo de pagamento inv\xe1lido"},{status:400});let{data:p,error:d}=await t.from("profiles").select("*").eq("id",r.id).single();if(d||!p)return l.Z.json({error:"Perfil n\xe3o encontrado"},{status:404});let m=u[s],g=p.cpf||p.cpfCnpj;if(!g)return l.Z.json({error:"CPF \xe9 obrigat\xf3rio para criar assinaturas. Por favor, adicione seu CPF nas configura\xe7\xf5es do perfil.",requiresCpf:!0},{status:400});let h=g.replace(/\D/g,"");if(11!==h.length&&14!==h.length)return l.Z.json({error:"CPF/CNPJ inv\xe1lido. Por favor, verifique o CPF informado."},{status:400});let f=p.asaas_customer_id;if(f)try{console.log("\uD83D\uDD0D Verificando customer existente no Asaas:",f);let e=await (0,c.oJ)(f);e.cpfCnpj?console.log("✅ Customer j\xe1 tem CPF:",e.cpfCnpj):(console.log("\uD83D\uDD04 Customer sem CPF, atualizando..."),await (0,c.zU)(f,{cpfCnpj:h}),console.log("✅ Customer atualizado com CPF"))}catch(e){console.error("Erro ao verificar/atualizar customer:",e);try{let e={name:p.nome,email:p.email,phone:p.whatsapp||p.telefone,externalReference:r.id,cpfCnpj:h};f=(await (0,c.lA)(e)).id,await t.from("profiles").update({asaas_customer_id:f}).eq("id",r.id)}catch(e){return console.error("Erro ao recriar customer:",e),l.Z.json({error:"Erro ao processar customer: "+e.message},{status:500})}}else try{let e={name:p.nome,email:p.email,phone:p.whatsapp||p.telefone,externalReference:r.id,cpfCnpj:h};console.log("\uD83D\uDCDD Criando customer no Asaas com dados:",{name:e.name,email:e.email,hasCpf:!!e.cpfCnpj,cpfLength:e.cpfCnpj.length}),f=(await (0,c.lA)(e)).id,await t.from("profiles").update({asaas_customer_id:f}).eq("id",r.id)}catch(e){return console.error("Erro ao criar customer:",e),l.Z.json({error:"Erro ao criar customer: "+e.message},{status:500})}let C=new Date;C.setDate(C.getDate()+7);let D=C.toISOString().split("T")[0];try{console.log("\uD83D\uDCDD Criando assinatura no Asaas...",{customer:f,billingType:n,value:m,nextDueDate:D}),o=await (0,c.y5)({customer:f,billingType:n,value:m,nextDueDate:D,cycle:"MONTHLY",description:`Assinatura ${s} - PLENIPAY`,externalReference:r.id}),console.log("✅ Assinatura criada:",{id:o.id,customer:o.customer,value:o.value})}catch(e){return console.error("❌ Erro ao criar assinatura:",e),console.error("Detalhes do erro:",{message:e.message,stack:e.stack}),l.Z.json({error:"Erro ao criar assinatura: "+e.message},{status:500})}let{error:I}=await t.from("profiles").update({asaas_subscription_id:o.id,plano:s,plano_status:"trial",plano_data_inicio:new Date().toISOString(),plano_data_fim:C.toISOString()}).eq("id",r.id);if(I)return console.error("Erro ao atualizar perfil:",I),l.Z.json({error:"Erro ao atualizar perfil"},{status:500});let y=null,A=null,x=null;if("PIX"===n){console.log("\uD83D\uDCB3 Processando pagamento PIX para assinatura:",o.id);try{console.log("⏳ Aguardando 3 segundos para pagamento ser gerado..."),await new Promise(e=>setTimeout(e,3e3)),console.log("\uD83D\uDD0D Buscando pagamentos da assinatura...");let e=await (0,c.LJ)(o.id);if(console.log("\uD83D\uDCCB Pagamentos encontrados:",{quantidade:e?.length||0,pagamentos:e?.map(e=>({id:e.id,status:e.status,billingType:e.billingType}))}),e&&e.length>0){let o=e[0];console.log("✅ Primeiro pagamento encontrado:",{id:o.id,status:o.status,billingType:o.billingType});let a=await (0,c._N)(o.id);console.log("\uD83D\uDCCB Detalhes do pagamento:",{id:a.id,status:a.status,hasPixCopiaECola:!!a.pixCopiaECola,hasPixQrCodeId:!!a.pixQrCodeId,invoiceUrl:a.invoiceUrl}),x=a.pixCopiaECola||a.pixCopyPaste||a.pixCopiaECola,console.log("\uD83D\uDD11 C\xf3digo PIX encontrado:",!!x);let t=process.env.ASAAS_API_URL||"https://www.asaas.com/api/v3",r=process.env.ASAAS_API_KEY.trim();r.startsWith("\\$")&&(r=r.substring(1));try{console.log("\uD83D\uDD0D Buscando QR code PIX em:",`${t}/payments/${o.id}/pixQrCode`);let e=await fetch(`${t}/payments/${o.id}/pixQrCode`,{headers:{access_token:r}});if(console.log("\uD83D\uDCE1 Resposta do QR code:",{status:e.status,ok:e.ok}),e.ok){let o=await e.json();console.log("✅ QR Code data recebido:",Object.keys(o)),A=o.encodedImage||o.base64||o.qrCode||o.encodedImage,!x&&o.payload&&(x=o.payload),!x&&o.pixCopiaECola&&(x=o.pixCopiaECola)}else{let o=await e.text();console.error("❌ Erro ao buscar QR code:",e.status,o)}}catch(e){console.error("❌ Erro ao buscar QR code:",e)}!A&&x&&console.log("⚠️ QR code n\xe3o encontrado, mas c\xf3digo PIX dispon\xedvel"),y=a.invoiceUrl||a.invoiceNumber}else{console.log("⚠️ Nenhum pagamento encontrado ainda, tentando novamente..."),await new Promise(e=>setTimeout(e,5e3));let e=await (0,c.LJ)(o.id);if(console.log("\uD83D\uDD04 Retry - Pagamentos encontrados:",e?.length||0),e&&e.length>0){let o=await (0,c._N)(e[0].id);x=o.pixCopiaECola||o.pixCopyPaste,y=o.invoiceUrl;try{let o=process.env.ASAAS_API_URL||"https://www.asaas.com/api/v3",a=process.env.ASAAS_API_KEY.trim();a.startsWith("\\$")&&(a=a.substring(1));let t=await fetch(`${o}/payments/${e[0].id}/pixQrCode`,{headers:{access_token:a}});if(t.ok){let e=await t.json();A=e.encodedImage||e.base64||e.qrCode}}catch(e){console.error("Erro ao buscar QR code no retry:",e)}}}}catch(e){console.error("Erro ao buscar pagamento PIX:",e)}}else y=o.invoiceUrl;return console.log("✅ Retornando dados do checkout:",{success:!0,paymentUrl:y||"N\xe3o dispon\xedvel",pixQrCode:A?"Presente":"Ausente",pixCopyPaste:x?"Presente":"Ausente",subscriptionId:o.id,plano:s,metodoPagamento:n}),l.Z.json({success:!0,paymentUrl:y,pixQrCode:A,pixCopyPaste:x,subscriptionId:o.id,plano:s,metodoPagamento:n})}catch(e){return console.error("Erro no checkout:",e),l.Z.json({error:e.message||"Erro ao processar pagamento"},{status:500})}}let d=new r.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/pagamento/checkout/route",pathname:"/api/pagamento/checkout",filename:"route",bundlePath:"app/api/pagamento/checkout/route"},resolvedPagePath:"/Users/charllestabordas/Documents/SISTEMA DE CONTAS/app/api/pagamento/checkout/route.ts",nextConfigOutput:"",userland:t}),{requestAsyncStorage:m,staticGenerationAsyncStorage:g,serverHooks:h,headerHooks:f,staticGenerationBailout:C}=d,D="/api/pagamento/checkout/route";function I(){return(0,n.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:g})}},84113:(e,o,a)=>{a.d(o,{LJ:()=>l,_N:()=>u,lA:()=>s,oJ:()=>i,y5:()=>n,zU:()=>c});let t=process.env.ASAAS_API_URL||"https://sandbox.asaas.com/api/v3",r=process.env.ASAAS_API_KEY;async function s(e){let o=await fetch(`${t}/customers`,{method:"POST",headers:{"Content-Type":"application/json",access_token:r},body:JSON.stringify(e)});if(!o.ok){let e=await o.json();throw Error(e.errors?.[0]?.description||e.message||"Erro ao criar customer")}return o.json()}async function n(e){let o=await fetch(`${t}/subscriptions`,{method:"POST",headers:{"Content-Type":"application/json",access_token:r},body:JSON.stringify(e)});if(!o.ok){let e=await o.json();throw Error(e.errors?.[0]?.description||e.message||"Erro ao criar assinatura")}return o.json()}async function i(e){let o=await fetch(`${t}/customers/${e}`,{headers:{access_token:r}});if(!o.ok)throw Error("Erro ao buscar customer");return o.json()}async function c(e,o){let a=await fetch(`${t}/customers/${e}`,{method:"PUT",headers:{"Content-Type":"application/json",access_token:r},body:JSON.stringify(o)});if(!a.ok){let e=await a.json();throw Error(e.errors?.[0]?.description||e.message||"Erro ao atualizar customer")}return a.json()}async function l(e){let o=await fetch(`${t}/subscriptions/${e}/payments`,{headers:{access_token:r}});if(!o.ok)throw Error("Erro ao buscar pagamentos da assinatura");return(await o.json()).data||[]}async function u(e){let o=await fetch(`${t}/payments/${e}`,{headers:{access_token:r}});if(!o.ok)throw Error("Erro ao buscar pagamento");return o.json()}},81664:(e,o,a)=>{a.d(o,{eI:()=>n,i3:()=>i,vv:()=>c});var t=a(77497),r=a(94128),s=a(32455);let n=(0,a(40002).cache)(async()=>{let e=await (0,s.cookies)();return(0,t.createServerClient)("https://frhxqgcqmxpjpnghsvoe.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZyaHhxZ2NxbXhwanBuZ2hzdm9lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2NTM3NTYsImV4cCI6MjA3OTIyOTc1Nn0.p1OxLRA5DKgvetuy-IbCfYClNSjrvK6fm43aZNX3T7I",{cookies:{getAll:()=>e.getAll(),setAll(o){try{o.forEach(({name:o,value:a,options:t})=>e.set(o,a,t))}catch{}}}})});function i(){let e=process.env.SUPABASE_SERVICE_ROLE_KEY;return e?(0,r.eI)("https://frhxqgcqmxpjpnghsvoe.supabase.co",e,{auth:{autoRefreshToken:!1,persistSession:!1}}):null}function c(){return(0,r.eI)("https://frhxqgcqmxpjpnghsvoe.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZyaHhxZ2NxbXhwanBuZ2hzdm9lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2NTM3NTYsImV4cCI6MjA3OTIyOTc1Nn0.p1OxLRA5DKgvetuy-IbCfYClNSjrvK6fm43aZNX3T7I",{auth:{autoRefreshToken:!1,persistSession:!1}})}},50482:(e,o,a)=>{e.exports=a(20399)},40002:(e,o,a)=>{e.exports=a(50482).vendored["react-rsc"].React},95419:(e,o,a)=>{e.exports=a(30517)}};var o=require("../../../../webpack-runtime.js");o.C(e);var a=e=>o(o.s=e),t=o.X(0,[1638,2455,4128,7497,8070],()=>a(67799));module.exports=t})();